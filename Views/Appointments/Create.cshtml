@model PruebaHospital.Models.Appointment

@{
    ViewData["Title"] = "Agendar Cita";
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 text-warning">
            <i class="bi bi-calendar-plus me-2"></i>Agendar Nueva Cita
        </h1>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Volver a la lista
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form asp-action="Create" method="post" class="row g-3">
                @Html.AntiForgeryToken()
                
                <div class="col-md-6">
                    <label asp-for="PatientId" class="form-label fw-semibold">Paciente *</label>
                    <select asp-for="PatientId" class="form-select" id="patientSelect">
                        <option value="">Seleccione un paciente</option>
                        @foreach (var patient in ViewBag.Patients)
                        {
                            <option value="@patient.Id">@patient.FullName - @patient.Document</option>
                        }
                    </select>
                    <span asp-validation-for="PatientId" class="text-danger small"></span>
                </div>
                
                <div class="col-md-6">
                    <label asp-for="DoctorId" class="form-label fw-semibold">Médico *</label>
                    <select asp-for="DoctorId" class="form-select" id="doctorSelect">
                        <option value="">Seleccione un médico</option>
                        @foreach (var doctor in ViewBag.Doctors)
                        {
                            <option value="@doctor.Id" data-speciality="@doctor.Speciality">@doctor.Name - @doctor.Speciality</option>
                        }
                    </select>
                    <span asp-validation-for="DoctorId" class="text-danger small"></span>
                </div>
                
                <div class="col-md-6">
                    <label asp-for="Date" class="form-label fw-semibold">Fecha *</label>
                    <input asp-for="Date" type="date" class="form-control" min="@DateTime.Today.ToString("yyyy-MM-dd")" id="dateInput" />
                    <span asp-validation-for="Date" class="text-danger small"></span>
                </div>
                
                <div class="col-md-6">
                    <label asp-for="Time" class="form-label fw-semibold">Hora *</label>
                    <select asp-for="Time" class="form-select" id="timeSelect">
                        <option value="">Seleccione una hora</option>
                    </select>
                    <span asp-validation-for="Time" class="text-danger small"></span>
                    <div class="form-text" id="timeSlotsInfo"></div>
                </div>
                
                <div class="col-12">
                    <label asp-for="Reason" class="form-label fw-semibold">Motivo de la consulta</label>
                    <textarea asp-for="Reason" class="form-control" rows="3" placeholder="Describa el motivo de la consulta..."></textarea>
                    <span asp-validation-for="Reason" class="text-danger small"></span>
                </div>

                <div class="col-12 mt-4">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-check-circle me-1"></i>Agendar Cita
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="alert alert-info mt-4">
        <h6 class="alert-heading"><i class="bi bi-info-circle me-1"></i>Información importante</h6>
        <small class="mb-0">
            • Las citas solo pueden agendarse en días hábiles (lunes a viernes)<br>
            • El horario de atención es de 8:00 AM a 6:00 PM<br>
            • Se validará que no haya conflictos de horario con el médico o paciente<br>
            • Se enviará un email de confirmación automáticamente
        </small>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const doctorSelect = document.getElementById('doctorSelect');
            const dateInput = document.getElementById('dateInput');
            const timeSelect = document.getElementById('timeSelect');
            const timeSlotsInfo = document.getElementById('timeSlotsInfo');
            
            function generateTimeSlots() {
                timeSelect.innerHTML = '<option value="">Seleccione una hora</option>';
                timeSlotsInfo.textContent = '';
                
                if (!doctorSelect.value || !dateInput.value) return;

                const timeSlots = [];
                const startTime = new Date().setHours(8, 0, 0); // 8:00 AM
                const endTime = new Date().setHours(18, 0, 0);  // 6:00 PM
                
                for (let time = startTime; time <= endTime; time += 30 * 60 * 1000) {
                    const date = new Date(time);
                    const timeString = date.toTimeString().substring(0, 5);
                    timeSlots.push(timeString);
                }

                timeSlots.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot;
                    option.textContent = slot;
                    timeSelect.appendChild(option);
                });

                timeSlotsInfo.textContent = `${timeSlots.length} horarios disponibles`;
            }

            doctorSelect.addEventListener('change', generateTimeSlots);
            dateInput.addEventListener('change', generateTimeSlots);
            
            document.getElementById('patientSelect').focus();
        });
    </script>
}